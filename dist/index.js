/* yocto-logger - Ready to use logger utility based on winston. - V2.0.0 */
"use strict";function Logger(){this.logLevel=5,this.TYPE_CONSOLE="console",this.TYPE_DAILY_ROTATE_FILE="daily-rotate-file",this.ERROR_LOG_LEVEL={name:"error",level:0,fn:"error"},this.WARNING_LOG_LEVEL={name:"warning",level:1,fn:"warn"},this.INFO_LOG_LEVEL={name:"info",level:2,fn:"info"},this.VERBOSE_LOG_LEVEL={name:"verbose",level:3,fn:"verbose"},this.DEBUG_LOG_LEVEL={name:"debug",level:4,fn:"debug"},this.SILLY_LOG_LEVEL={name:"silly",level:5,fn:"silly"};var a=function(a,b){b=b||!1;var c={level:a.level,date:_.isFunction(a.timestamp)?a.timestamp():_.isNull(a.timestamp)?null:moment().format(),message:_.isUndefined(a.message)||_.isEmpty(a.message)?"":a.message,meta:!_.isUndefined(a.meta)&&Object.keys(a.meta).length?JSON.stringify(a.meta):""};_.has(a,"label")&&_.isFunction(a.label)&&(c.level=a.label(a.level.toUpperCase())),_.has(a,"timestamp")&&_.isFunction(a.timestamp)&&(c.date=a.timestamp()),b&&_.has(a,"colorize")&&_.isFunction(a.colorize)&&(b=a.colorize(a.level),c.level=chalk[b]("[{}]".format(a.label(a.level.toUpperCase(),4," "),3," ")));var d="{level}";return _.isNull(c.date)||(d=["[{date}]",d].join(" ")),_.isUndefined(c.message)||_.isEmpty(c.message)||(d=[d,"{message}"].join(" ")),_.isUndefined(c.meta)||_.isEmpty(c.meta)||(d=[d,"{meta}"].join(" ")),d.format(c)},b=function(){return moment().format("YYYY/MM/DD HH:mm:ss")},c=function(a){var b=[{info:"info    "},{warn:"warning "},{error:"error   "},{debug:"debug   "},{verbose:"verbose "},{silly:"silly"}],c=_.findIndex(b,a);return c>=0?_.first(_.values(b[c])):a},d=function(a){var b=[{info:"green"},{warn:"yellow"},{error:"red"},{debug:"blue"},{verbose:"white"},{silly:"magenta"}],c=_.findIndex(b,a);return c>=0?_.first(_.values(b[c])):"white"};this.consoleTransportFormatter=function(b){return a(b,!0)},this.dailyRotateFileTransportFormatter=function(b){return a(b,!1)},this.defaultConsoleTransport={level:"debug",handleExceptions:!0,humanReadableUnhandledException:!0,json:!1,showLevel:!0,silent:!1,label:c,formatter:this.consoleTransportFormatter,timestamp:b,colorize:d},this.defaultDailyRotateTransportFile={name:"default-daily-rotate-transport",level:"verbose",dirname:"./",filename:uuid.v4(),handleExceptions:!0,humanReadableUnhandledException:!0,json:!1,maxsize:5242880,maxFiles:5,colorize:!0,datePattern:"-yyyy-MM-dd.log",label:c,formatter:this.dailyRotateFileTransportFormatter,timestamp:b},this.winston=new winston.Logger({transports:[new winston.transports.Console(_.clone(this.defaultConsoleTransport))],exitOnError:!1})}var winston=require("winston"),_=require("lodash"),chalk=require("chalk"),moment=require("moment"),format=require("string-format"),uuid=require("uuid"),fs=require("fs"),path=require("path"),Promise=require("promise"),rotate=require("winston-daily-rotate-file");format.extend(String.prototype),winston.emitErrs=!1,Logger.prototype.enableConsole=function(a){a=!_.isBoolean(a)||a;var b=a?"enableConsole":"disableConsole";if(!_.isUndefined(this.winston.transports)||!_.isNull(this.winston.transports)&&_.isObject(this.winston.transports)){if(_.has(this.winston.transports,"console")&&_.has(this.winston.transports.console,"silent"))return this.winston.transports.console.silent=!a,a&&this.info(["[ Logger.",b," ] - enable console on current logger"].join("")),!0}else console.log(chalk.red(["[ Logger.",b," ] - winston doesn't exists."].join("")));return!1},Logger.prototype.disableConsole=function(){return this.info("[ Logger.disableConsole ] - disable console on current logger"),this.enableConsole(!1)},Logger.prototype.enableExceptions=function(a,b){a=!_.isBoolean(a)||a;var c=a?"enableExceptions":"disableExceptions";if(a&&this.info("[ Logger.enableExceptions ] - Try to enable exceptions on logger"),!_.isUndefined(this.winston.transports)||!_.isNull(this.winston.transports)&&_.isObject(this.winston.transports)){var d=Object.keys(this.winston.transports);d=_.isString(b)&&!_.isEmpty(b)?_.filter(d,function(a){return a===b}):d,_.each(d,function(b){return this.info(["[ Logger.",c," ] - ",c.replace("Exceptions"," exceptions")," for transport ",b].join("")),this.winston.transports[b].handleExceptions=!a,!0}.bind(this))}else console.log(chalk.red(["[ Logger.",c," ] - winston doesn\t exists."].join("")));return!1},Logger.prototype.disableExceptions=function(a){return this.info("[ Logger.disableExceptions ] - Try to disable exceptions on logger"),this.enableExceptions(!1,a)},Logger.prototype.addDailyRotateTransport=function(a,b,c){(_.isUndefined(a)||!_.isString(a)||_.isNull(a))&&(a="./",this.warning("[ Logger.addDailyRotateTransport ] - Invalid path given. Using default path './'")),a=path.normalize(a),a=path.resolve(a);var d;return new Promise(function(e,f){fs.lstat(a,function(g,h){h&&h.isDirectory()?fs.access(a,fs.F_OK|fs.R_OK|fs.W_OK,function(g){if(g)d=["[ Logger.addDailyRotateTransport ] - Cannot read and write on",a," - operation aborted !"].join(" "),this.error(d),f(d);else{var h=_.clone(this.defaultDailyRotateTransportFile);_.extend(h,{dirname:a}),_.isUndefined(c)||_.isNull(c)||!_.isObject(c)||_.extend(h,c),_.isUndefined(b)||_.isEmpty(b)||_.isNull(b)||(_.isString(b)&&!_.isEmpty(b)?_.extend(h,{filename:b}):this.warning(["[ Logger.addDailyRotateTransport ] -","filename is not a string. restore filename to",h.filename].join(" "))),_.isUndefined(this.winston)?(d=["[ Logger.addDailyRotateTransport ] -","Cannot add new transport. instance is invalid"].join(" "),this.error(d),f(d)):(_.has(this.winston.transports,h.name)&&(this.warning(["[ Logger.addDailyRotateTransport ] - A transport with the name",h.name,"already exists. Removing current before adding new transport"].join(" ")),this.winston.remove(h.name)),this.winston.add(rotate,h),b=[a,"/",h.filename,moment().format(h.datePattern.replace(".log","").toUpperCase()),".log"].join(""),this.info(["[ Logger.addDailyRotateTransport ] - Success ! Datas are logged in",b].join(" ")),this.winston.transports[h.name].isDefault=!(!_.isUndefined(c)&&_.isString(c.name)&&!_.isEmpty(c.name)&&c.name!==this.defaultDailyRotateTransportFile.name),e(_.get(this.winston.transports,h.name)))}}.bind(this)):(d=["[ Logger.addDailyRotateTransport ] - Directory path : [",a,"] is invalid.",g,"Operation aborted !"].join(" "),this.error(d),f(d))}.bind(this))}.bind(this))},Logger.prototype.process=function(a,b,c,d){try{if(_.isUndefined(this.winston)||_.isNull(this.winston))throw"Cannot une winston logger. instance is undefined or null";if(_.has(a,"fn")){var e=this.winston,f=this.winston.transports;return _.isString(d)&&!_.isEmpty(d)&&_.has(f,d)&&(e=_.get(f,d)),_.isUndefined(c)?e.log(a.fn,b):e.log(a.fn,b,c)}throw"Fn function is undefined or null. cannot process log"}catch(a){console.log(chalk.red(["[ Logger.process ] -",a].join(" ")))}return!1},Logger.prototype.changeLevel=function(a,b,c,d){var e=[this.ERROR_LOG_LEVEL,this.WARNING_LOG_LEVEL,this.INFO_LOG_LEVEL,this.VERBOSE_LOG_LEVEL,this.DEBUG_LOG_LEVEL,this.SILLY_LOG_LEVEL];if(this.logLevel=b,a!==b)if(!_.isUndefined(c)&&_.isBoolean(c)&&c?this.info(["[ Logger.changeLevel ] - Try to change level from",e[a].name,"to",e[b].name].join(" ")):this.info(["[ Logger.changeLevel ] - Try to change level from",e[a].name,"to",e[b].name].join(" ")),!_.isUndefined(this.winston.transports)||!_.isNull(this.winston.transports)&&_.isObject(this.winston.transports)){var f=this.winston.transports;_.isString(d)&&!_.isEmpty(d)&&_.has(f,d)&&(f=[_.get(f,d)]),_.each(f,function(a){_.has(a,"level")&&(a.level=e[this.logLevel].fn,this.info(["[ Logger.changeLevel ] - Level was changed to",e[this.logLevel].name,"for",a.name].join(" ")))}.bind(this))}else this.error("[ Logger.changeLevel ] - Cannot change level. Transport is not defined");else this.info(["[ Logger.changeLevel ] - Unchange level to",e[this.logLevel].name].join(" "));return this},Logger.prototype.setLogLevel=function(a,b){var c=[this.ERROR_LOG_LEVEL,this.WARNING_LOG_LEVEL,this.INFO_LOG_LEVEL,this.VERBOSE_LOG_LEVEL,this.DEBUG_LOG_LEVEL,this.SILLY_LOG_LEVEL],d=_.find(c,["level",this.logLevel]),e=_.find(c,["name",a]);return!_.isUndefined(e)&&_.has(e,"level")&&_.isNumber(e.level)&&!_.isUndefined(d)&&_.has(d,"level")&&_.isNumber(d.level)?this.changeLevel(this.logLevel,e.level,d.level>e.level,b):(this.warning(["[ Logger.setLogLevel ] - Cannot change log level manually.","Given level [",a,"] was not founded."].join(" ")),!1)},Logger.prototype.more=function(a){var b=this.logLevel,c=b<5?b+1:b;return this.info("[ Logger.more ] - Requesting more logs"),this.changeLevel(b,c,!1,a)},Logger.prototype.less=function(a){var b=this.logLevel,c=b>0?b-1:b;return this.info("[ Logger.less ] - Requesting less logs"),this.changeLevel(b,c,!0,a)},Logger.prototype.verbose=function(a,b,c){return this.process(this.VERBOSE_LOG_LEVEL,a,b,c)},Logger.prototype.info=function(a,b,c){return this.process(this.INFO_LOG_LEVEL,a,b,c)},Logger.prototype.warning=function(a,b,c){return this.process(this.WARNING_LOG_LEVEL,a,b,c)},Logger.prototype.error=function(a,b,c){return this.process(this.ERROR_LOG_LEVEL,a,b,c)},Logger.prototype.debug=function(a,b,c){return this.process(this.DEBUG_LOG_LEVEL,a,b,c)},Logger.prototype.silly=function(a,b,c){return this.process(this.SILLY_LOG_LEVEL,a,b,c)},Logger.prototype.banner=function(a,b){var c={color:"white",bgColor:"bgBlack",tDelim:"-",bDelim:"-",lDelim:"|",rDelim:"|"};!_.isUndefined(b)&&_.has(b,"color")&&_.has(b,"bgColor")&&(_.startsWith("bg",b.bgColor)||(b.bgColor=["bg",_.capitalize(b.bgColor.toLowerCase())].join("")),_.extend(c,b));var d=[c.lDelim,a,c.rDelim].join(" ");return _.has(chalk.styles,c.color)&&_.has(chalk.styles,c.bgColor)?(console.log(chalk[c.color][c.bgColor](_.repeat(c.tDelim,d.length))),console.log(chalk[c.color][c.bgColor](d)),console.log(chalk[c.color][c.bgColor](_.repeat(c.bDelim,d.length)))):(this.warning(["[ Logger.Banner ] - Cannot use custom style given style is invalid.","Please read chalk documentation. Logging with current shell config."].join(" ")),console.log(_.repeat(c.tDelim,d.length)),console.log(d),console.log(_.repeat(c.bDelim,d.length))),!0},module.exports=new Logger;