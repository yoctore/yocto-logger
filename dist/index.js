/* yocto-logger - Ready to use logger utility based on winston. - V4.0.0 - Wed Aug 29 2018 14:22:32 GMT+0400 (+04)*/

"use strict";const winston=require("winston"),_=require("lodash"),chalk=require("chalk"),moment=require("moment"),fs=require("fs"),path=require("path"),stackTrace=require("stack-trace"),morgan=require("morgan"),os=require("os");require("winston-daily-rotate-file");class Logger{constructor(){this.levels=_.map(winston.config.syslog.levels,function(e,t){return{level:e,fn:t,name:t.replace(/^crit$/g,"critical").replace(/^emerg$/g,"emergency"),useCallback:e>=0&&e<3}}),this.logLevel=_.find(this.levels,["name","production"===process.env.NODE_ENV?"notice":"debug"]),this.defaultTransformer=winston.format(function(e){_.isString(e.message)&&(e.message=e.message.replace(/%s/g,'"%s"'));const t=stackTrace.get(),n=_.size(t)>=22?t[22]:null;return _.isFunction(n.getMethodName)&&_.isFunction(n.getFileName)&&(e.from=n.getMethodName()||n.getFileName(),e.from=e.from.replace(process.cwd(),""),path.extname(e.from)||_.includes(n.getTypeName(),["Object"])||(e.from=[n.getTypeName(),e.from].join(".")),e.from=[e.from,n.getLineNumber()].join(":")),e.level=_.padEnd(e.level.toUpperCase(),7," "),e}),this.defaultTimestampFormat=winston.format(e=>(e.timestamp=moment(e.timestamp).format("YYYY/MM/DD HH:mm:ss"),e)),this.defaultPrintTranformer=winston.format.printf(e=>_.isUndefined(e.label)?`[${e.timestamp}] | ${e.level} -> [${e.from}] : ${e.message}`:`[${e.timestamp}] -> ${e.level} - [${e.label}] : ${e.message}`),this.defaultWebPrintTranformer=winston.format.printf(e=>e.message.replace(os.EOL,"")),this.winston=winston.createLogger({transports:[new winston.transports.Console({handleExceptions:!0,format:winston.format.combine(this.defaultTransformer(),winston.format.timestamp(),this.defaultTimestampFormat(),winston.format.label(),winston.format.colorize(),winston.format.splat(),this.defaultPrintTranformer)})],silent:!1,levels:winston.config.syslog.levels,level:this.logLevel.name}),this.webLogger=winston.createLogger()}static create(){return new Logger}enableConsole(e){return e=!_.isBoolean(e)||e,_.each(this.winston.transports,t=>{t instanceof winston.transports.Console&&(t.silent=!e)}),!1}disableConsole(){return this.info("[ Logger.disableConsole ] - Disabling console transport"),this.enableConsole(!1)}enableErrorToDailyRotateFiles(e={}){return e.extname="error",e.level="warning",e.canChangeLevel=!1,this.addDailyRotateTransport(e)}enableRequestToDailyRotateFiles(e={}){if(e.extname="access",e.level="info",e.canChangeLevel=!1,e.xheaders=e.xheaders||[],this.addDailyRotateTransport(e,!0)){this.webLogger.stream={write:e=>{this.webLogger.info(e)}};const t=e.xheaders?[morgan.combined,"- :xheaders"].join(" "):"combined";return e.xheaders&&morgan.token("xheaders",function(t){return _.compact(_.map(t.headers,(t,n)=>!!_.includes(e.xheaders,n)&&["(",n,") ",t].join(""))).join(" - ")}),morgan(t,{stream:this.webLogger.stream})}return!1}addDailyRotateTransport(e={},t=!1){_.set(e,"changeChangeLevel",e.canChangeLevel||!0),_.set(e,"extname",e.extname||"combined"),_.set(e,"destination",path.resolve((e.destination||".").replace(/\/+/g,"/").replace(/\/$/,""))),_.set(e,"filename",[_.compact(["%DATE%",e.filename||"",e.extname]).join("-"),"log"].join(".")),_.set(e,"pattern",e.pattern||"YYYYMMDD"),_.set(e,"zipped",e.zipped||!0),_.set(e,"size",e.size||"20m"),_.set(e,"delay",e.delay||"14d"),_.set(e,"level",e.level||"debug");try{if(fs.lstatSync(e.destination).isDirectory()){const n=new winston.transports.DailyRotateFile({dirname:e.destination,filename:e.filename,datePattern:e.pattern,zippedArchive:e.zipped,maxSize:e.size,maxFiles:e.delay,handleExceptions:!t,colorize:!1,level:e.level,canChangeLevel:e.changeChangeLevel,format:winston.format.combine(this.defaultTransformer(),winston.format.timestamp(),this.defaultTimestampFormat(),winston.format.label(),winston.format.splat(),t?this.defaultWebPrintTranformer:this.defaultPrintTranformer)});return t?this.webLogger.add(n):this.winston.add(n)}this.warning("Cannot create daily rotate file log handler. Path %s is not a directory.",e.destination)}catch(e){this.error("Cannot add a new daily rotate file : %s",e.message)}return!1}changeLogLevel(e){const t=_.find(this.levels,["name",e]);_.each(this.winston.transports,function(e){"console"===e.name&&_.has(e,"options.canChangeLevel")&&_.get(e,"options.canChangeLevel")&&(e.previousLevel=e.level||e.parent.level,e.level=_.isUndefined(t)?null:t.name,this.notice("Level change from %s to %s form transport %s",e.previousLevel,e.level,e.name))}.bind(this)),_.isUndefined(t)&&this.notice("Invalid level value. The defaut value %s was used.",this.winston.level)}process(e,t,n){return(e=_.find(this.levels,["name",e])).useCallback&&this.callback&&_.isFunction(this.callback)?callback(e,t,n):((_.isObject(t)||_.isArray(t))&&(t=JSON.stringify(t)),this.winston.log(e.fn,t,...n))}emergency(e,...t){return this.process("emergency",e,t)}alert(e,...t){return this.process("alert",e,t)}critical(e,...t){return this.process("critical",e,t)}error(e,...t){return this.process("error",e,t)}warning(e,...t){return this.process("warning",e,t)}notice(e,...t){return this.process("notice",e,t)}info(e,...t){return this.process("info",e,t)}debug(e,...t){return this.process("debug",e,t)}banner(e,...t){return e?(e=[_.repeat(" ",10),e.toUpperCase(),_.repeat(" ",10)].join(""),this.process("info",chalk.bgWhite.black(e),t)):this.process("info",e||"",t)}deprecated(e,t,n=""){return this.process("notice",[chalk.yellow("[DEPRECATED]"),`Method %s is depreacted. Prefere use %s. ${n}`].join(" "),[e,t])}}module.exports=Logger;