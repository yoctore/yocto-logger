/* yocto-logger - Ready to use logger utility based on winston. - V3.0.0 */

"use strict";var winston=require("winston"),_=require("lodash"),chalk=require("chalk"),moment=require("moment"),format=require("string-format"),uuid=require("uuid"),fs=require("fs"),path=require("path"),Promise=require("promise"),rotate=require("winston-daily-rotate-file");function Logger(){this.logLevel=5,this.TYPE_CONSOLE="console",this.TYPE_DAILY_ROTATE_FILE="daily-rotate-file",this.ERROR_LOG_LEVEL={name:"error",level:0,fn:"error"},this.WARNING_LOG_LEVEL={name:"warning",level:1,fn:"warn"},this.INFO_LOG_LEVEL={name:"info",level:2,fn:"info"},this.VERBOSE_LOG_LEVEL={name:"verbose",level:3,fn:"verbose"},this.DEBUG_LOG_LEVEL={name:"debug",level:4,fn:"debug"},this.SILLY_LOG_LEVEL={name:"silly",level:5,fn:"silly"};var e=function(e,t){t=t||!1;var n=null;_.isFunction(e.timestamp)?n=e.timestamp():_.isNull(e.timestamp)||(n=moment().format());var o={level:e.level,date:n,message:_.isUndefined(e.message)||_.isEmpty(e.message)?"":e.message,meta:!_.isUndefined(e.meta)&&Object.keys(e.meta).length?JSON.stringify(e.meta):""};_.has(e,"label")&&_.isFunction(e.label)&&(o.level=e.label(e.level.toUpperCase())),_.has(e,"timestamp")&&_.isFunction(e.timestamp)&&(o.date=e.timestamp()),t&&_.has(e,"colorize")&&_.isFunction(e.colorize)&&(t=e.colorize(e.level),o.level=chalk[t]("[{}]".format(e.label(e.level.toUpperCase(),4," "),3," ")));var i="{level}";return _.isNull(o.date)||(i=["[{date}]",i].join(" ")),_.isUndefined(o.message)||_.isEmpty(o.message)||(i=[i,"{message}"].join(" ")),_.isUndefined(o.meta)||_.isEmpty(o.meta)||(i=[i,"{meta}"].join(" ")),i.format(o)},t=function(){return moment().format("YYYY/MM/DD HH:mm:ss")},n=function(e){var t=[{info:"info    "},{warn:"warning "},{error:"error   "},{debug:"debug   "},{verbose:"verbose "},{silly:"silly"}],n=_.findIndex(t,e);return n>=0?_.first(_.values(t[n])):e};this.consoleTransportFormatter=function(t){return e(t,!0)},this.dailyRotateFileTransportFormatter=function(t){return e(t,!1)},this.defaultConsoleTransport={level:"debug",handleExceptions:!0,humanReadableUnhandledException:!0,json:!1,showLevel:!0,silent:!1,label:n,formatter:this.consoleTransportFormatter,timestamp:t,colorize:function(e){var t=[{info:"green"},{warn:"yellow"},{error:"red"},{debug:"blue"},{verbose:"white"},{silly:"magenta"}],n=_.findIndex(t,e);return n>=0?_.first(_.values(t[n])):"white"}},this.defaultDailyRotateTransportFile={name:"default-daily-rotate-transport",level:"verbose",dirname:"./",filename:uuid.v4(),handleExceptions:!0,humanReadableUnhandledException:!0,json:!1,maxsize:5242880,maxFiles:5,colorize:!0,datePattern:"-yyyy-MM-dd.log",label:n,formatter:this.dailyRotateFileTransportFormatter,timestamp:t},this.winston=new winston.Logger({transports:[new winston.transports.Console(_.clone(this.defaultConsoleTransport))],exitOnError:!1})}format.extend(String.prototype),winston.emitErrs=!1,Logger.prototype.enableConsole=function(e){var t=(e=!_.isBoolean(e)||e)?"enableConsole":"disableConsole";if(!_.isUndefined(this.winston.transports)||!_.isNull(this.winston.transports)&&_.isObject(this.winston.transports)){if(_.has(this.winston.transports,"console")&&_.has(this.winston.transports.console,"silent"))return this.winston.transports.console.silent=!e,e&&this.info(["[ Logger.",t," ] - enable console on current logger"].join("")),!0}else console.log(chalk.red(["[ Logger.",t," ] - winston doesn't exists."].join("")));return!1},Logger.prototype.disableConsole=function(){return this.info("[ Logger.disableConsole ] - disable console on current logger"),this.enableConsole(!1)},Logger.prototype.enableExceptions=function(e,t){var n=(e=!_.isBoolean(e)||e)?"enableExceptions":"disableExceptions";if(e&&this.info("[ Logger.enableExceptions ] - Try to enable exceptions on logger"),!_.isUndefined(this.winston.transports)||!_.isNull(this.winston.transports)&&_.isObject(this.winston.transports)){var o=Object.keys(this.winston.transports);o=_.isString(t)&&!_.isEmpty(t)?_.filter(o,function(e){return e===t}):o,_.each(o,function(t){return this.info(["[ Logger.",n," ] - ",n.replace("Exceptions"," exceptions")," for transport ",t].join("")),this.winston.transports[t].handleExceptions=!e,!0}.bind(this))}else console.log(chalk.red(["[ Logger.",n," ] - winston doesn\t exists."].join("")));return!1},Logger.prototype.disableExceptions=function(e){return this.info("[ Logger.disableExceptions ] - Try to disable exceptions on logger"),this.enableExceptions(!1,e)},Logger.prototype.addDailyRotateTransport=function(e,t,n){var o;return(_.isUndefined(e)||!_.isString(e)||_.isNull(e))&&(e="./",this.warning("[ Logger.addDailyRotateTransport ] - Invalid path given. Using default path './'")),e=path.normalize(e),e=path.resolve(e),new Promise(function(i,s){fs.lstat(e,function(r,a){a&&a.isDirectory()?fs.access(e,fs.F_OK||fs.R_OK||fs.W_OK,function(r){if(r)o=["[ Logger.addDailyRotateTransport ] - Cannot read and write on",e," - operation aborted !"].join(" "),this.error(o),s(o);else{var a=_.clone(this.defaultDailyRotateTransportFile);_.extend(a,{dirname:e}),_.isUndefined(n)||_.isNull(n)||!_.isObject(n)||_.extend(a,n),_.isUndefined(t)||_.isEmpty(t)||_.isNull(t)||(_.isString(t)&&!_.isEmpty(t)?_.extend(a,{filename:t}):this.warning(["[ Logger.addDailyRotateTransport ] -","filename is not a string. restore filename to",a.filename].join(" "))),_.isUndefined(this.winston)?(o=["[ Logger.addDailyRotateTransport ] -","Cannot add new transport. instance is invalid"].join(" "),this.error(o),s(o)):(_.has(this.winston.transports,a.name)&&(this.warning(["[ Logger.addDailyRotateTransport ] - A transport with the name",a.name,"already exists. Removing current before adding new transport"].join(" ")),this.winston.remove(a.name)),this.winston.add(rotate,a),t=[e,"/",a.filename,moment().format(a.datePattern.replace(".log","").toUpperCase()),".log"].join(""),this.info(["[ Logger.addDailyRotateTransport ] - Success ! Datas are logged in",t].join(" ")),this.winston.transports[a.name].isDefault=!(!_.isUndefined(n)&&_.isString(n.name)&&!_.isEmpty(n.name)&&n.name!==this.defaultDailyRotateTransportFile.name),i(_.get(this.winston.transports,a.name)))}}.bind(this)):(o=["[ Logger.addDailyRotateTransport ] - Directory path : [",e,"] is invalid.",r,"Operation aborted !"].join(" "),this.error(o),s(o))}.bind(this))}.bind(this))},Logger.prototype.process=function(e,t,n,o){try{if(_.isUndefined(this.winston)||_.isNull(this.winston))throw"Cannot une winston logger. instance is undefined or null";if(_.has(e,"fn")){var i=this.winston,s=this.winston.transports;return _.isString(o)&&!_.isEmpty(o)&&_.has(s,o)&&(i=_.get(s,o)),_.isUndefined(n)?i.log(e.fn,t):i.log(e.fn,t,n)}throw"Fn function is undefined or null. cannot process log"}catch(e){console.log(chalk.red(["[ Logger.process ] -",e].join(" ")))}return!1},Logger.prototype.changeLevel=function(e,t,n,o){var i=[this.ERROR_LOG_LEVEL,this.WARNING_LOG_LEVEL,this.INFO_LOG_LEVEL,this.VERBOSE_LOG_LEVEL,this.DEBUG_LOG_LEVEL,this.SILLY_LOG_LEVEL];if(this.logLevel=t,e!==t)if(!_.isUndefined(n)&&_.isBoolean(n),this.info(["[ Logger.changeLevel ] - Try to change level from",i[e].name,"to",i[t].name].join(" ")),!_.isUndefined(this.winston.transports)||!_.isNull(this.winston.transports)&&_.isObject(this.winston.transports)){var s=this.winston.transports;_.isString(o)&&!_.isEmpty(o)&&_.has(s,o)&&(s=[_.get(s,o)]),_.each(s,function(e){_.has(e,"level")&&(e.level=i[this.logLevel].fn,this.info(["[ Logger.changeLevel ] - Level was changed to",i[this.logLevel].name,"for",e.name].join(" ")))}.bind(this))}else this.error("[ Logger.changeLevel ] - Cannot change level. Transport is not defined");else this.info(["[ Logger.changeLevel ] - Unchange level to",i[this.logLevel].name].join(" "));return this},Logger.prototype.setLogLevel=function(e,t){var n=[this.ERROR_LOG_LEVEL,this.WARNING_LOG_LEVEL,this.INFO_LOG_LEVEL,this.VERBOSE_LOG_LEVEL,this.DEBUG_LOG_LEVEL,this.SILLY_LOG_LEVEL],o=_.find(n,["level",this.logLevel]),i=_.find(n,["name",e]);return!_.isUndefined(i)&&_.has(i,"level")&&_.isNumber(i.level)&&!_.isUndefined(o)&&_.has(o,"level")&&_.isNumber(o.level)?this.changeLevel(this.logLevel,i.level,o.level>i.level,t):(this.warning(["[ Logger.setLogLevel ] - Cannot change log level manually.","Given level [",e,"] was not founded."].join(" ")),!1)},Logger.prototype.more=function(e){var t=this.logLevel,n=t<5?t+1:t;return this.info("[ Logger.more ] - Requesting more logs"),this.changeLevel(t,n,!1,e)},Logger.prototype.less=function(e){var t=this.logLevel,n=t>0?t-1:t;return this.info("[ Logger.less ] - Requesting less logs"),this.changeLevel(t,n,!0,e)},Logger.prototype.verbose=function(e,t,n){return this.process(this.VERBOSE_LOG_LEVEL,e,t,n)},Logger.prototype.info=function(e,t,n){return this.process(this.INFO_LOG_LEVEL,e,t,n)},Logger.prototype.warning=function(e,t,n){return this.process(this.WARNING_LOG_LEVEL,e,t,n)},Logger.prototype.error=function(e,t,n){return this.process(this.ERROR_LOG_LEVEL,e,t,n)},Logger.prototype.debug=function(e,t,n){return this.process(this.DEBUG_LOG_LEVEL,e,t,n)},Logger.prototype.silly=function(e,t,n){return this.process(this.SILLY_LOG_LEVEL,e,t,n)},Logger.prototype.banner=function(e,t){var n={color:"white",bgColor:"bgBlack",tDelim:"-",bDelim:"-",lDelim:"|",rDelim:"|"};!_.isUndefined(t)&&_.has(t,"color")&&_.has(t,"bgColor")&&(_.startsWith("bg",t.bgColor)||(t.bgColor=["bg",_.capitalize(t.bgColor.toLowerCase())].join("")),_.extend(n,t));var o=[n.lDelim,e,n.rDelim].join(" ");try{console.log(chalk[n.color][n.bgColor](_.repeat(n.tDelim,o.length))),console.log(chalk[n.color][n.bgColor](o)),console.log(chalk[n.color][n.bgColor](_.repeat(n.bDelim,o.length)))}catch(e){this.warning(["[ Logger.Banner ] - error when write log : "+e+" . Logging with current shell value."].join(" ")),console.log(_.repeat(n.tDelim,o.length)),console.log(o),console.log(_.repeat(n.bDelim,o.length))}return!0},module.exports=new Logger;