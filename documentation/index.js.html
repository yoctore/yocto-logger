

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      index.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

  

  
  <script type="text/javascript" src="scripts/lodash.min.js"></script>
  <script type="text/javascript" src="scripts/search.js"></script>
  <link type="text/css" rel="stylesheet" href="styles/custom.css"/>
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      yocto-logger<br/>Version <span style='color:#0095dd'>v3.0.0</span>
    </h3>

    <h3>Classes</h3><ul><li id="Logger-nav"><a href="Logger.html">Logger</a><ul class='methods'><li data-type="method" id="Logger-create-nav"><a href="Logger.html#.create">create</a></li><li data-type="method" id="Logger-accessRequestToDailyRotateFiles-nav"><a href="Logger.html#accessRequestToDailyRotateFiles">accessRequestToDailyRotateFiles</a></li><li data-type="method" id="Logger-addDailyRotateTransport-nav"><a href="Logger.html#addDailyRotateTransport">addDailyRotateTransport</a></li><li data-type="method" id="Logger-alert-nav"><a href="Logger.html#alert">alert</a></li><li data-type="method" id="Logger-banner-nav"><a href="Logger.html#banner">banner</a></li><li data-type="method" id="Logger-changeLogLevel-nav"><a href="Logger.html#changeLogLevel">changeLogLevel</a></li><li data-type="method" id="Logger-critical-nav"><a href="Logger.html#critical">critical</a></li><li data-type="method" id="Logger-debug-nav"><a href="Logger.html#debug">debug</a></li><li data-type="method" id="Logger-disableConsole-nav"><a href="Logger.html#disableConsole">disableConsole</a></li><li data-type="method" id="Logger-emergency-nav"><a href="Logger.html#emergency">emergency</a></li><li data-type="method" id="Logger-enableConsole-nav"><a href="Logger.html#enableConsole">enableConsole</a></li><li data-type="method" id="Logger-error-nav"><a href="Logger.html#error">error</a></li><li data-type="method" id="Logger-errorToDailyRotateFiles-nav"><a href="Logger.html#errorToDailyRotateFiles">errorToDailyRotateFiles</a></li><li data-type="method" id="Logger-info-nav"><a href="Logger.html#info">info</a></li><li data-type="method" id="Logger-notice-nav"><a href="Logger.html#notice">notice</a></li><li data-type="method" id="Logger-process-nav"><a href="Logger.html#process">process</a></li><li data-type="method" id="Logger-warning-nav"><a href="Logger.html#warning">warning</a></li></ul></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        index.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>'use strict';

const winston       = require('winston');
const _             = require('lodash');
const chalk         = require('chalk');
const moment        = require('moment');
const fs            = require('fs');
const path          = require('path');
const stackTrace    = require('stack-trace');
const morgan        = require('morgan');
const os            = require('os');

// To this require to extend main winston var
require('winston-daily-rotate-file');

/**
 *
 * This class manage all method to add or use a logger instance on your app.
 *
 * This module is based on &lt;b>&lt;a class="blank" href="https://github.com/winstonjs/winston">winston&lt;/a>&lt;/b>
 * for default logging and &lt;b>&lt;a class="blank" href="https://github.com/expressjs/morgan">morgan&lt;/a>&lt;/b> for request access logging.
 *
 * This module is not a complete re-implementation of winston or morgan, we only use needed functionnality on this two module to create your own.
 *
 * With this module we can create log on &lt;code class="code">Console&lt;/code> and &lt;code class="code">File&lt;/code> with a daily rotate management.
 *
 * This module use syslog levels for logging action for more details see &lt;b>&lt;a class="blank" href="https://github.com/winstonjs/winston#logging-levels">here&lt;/a>&lt;/b>
 *
 * @example
 * // require the module
 * const logger = require('yocto-logger');
 *
 * // create your logger
 * const log = logger.create();
 *
 * // At this point just use your logger
 *
 * @constructor
 */
class Logger {
  /**
   * Default constructor of Logger class.
   *
   * Don't use it directly, prefer use &lt;code class="code">logger.create()&lt;/code> instead
   *
   * @constructor
   */
  constructor () {
    /**
     * Fsdfsdfsfdff fsd&lt;b>fsdfsd&lt;/b>fsfsdfsd fsfds
     *
     * @memberof Logger
     * @member {Array} levels lists of remap syslog levels for current app
     */
    this.levels = _.map(winston.config.syslog.levels, function (level, key) {
      // Default statement
      return {
        level       : level,
        fn          : key,
        name        : key.replace(/^crit$/g, 'critical').replace(/^emerg$/g, 'emergency'),
        useCallback : level >= 0 &amp;&amp; level &lt; 3
      }
    });

    /**
     * If &lt;code>process.env.NODE_ENV&lt;/code> is set to &lt;code>production&lt;/code> the &lt;code>notice&lt;/code> level was used by default,
     * otherwise the &lt;code>debug&lt;/code> level is used
     *
     * @memberof Logger
     * @member {Integer} logLevel default log level for current app
     * @default aaaaaaa
     */
    this.logLevel = _.find(this.levels, [ 'name', process.env.NODE_ENV === 'production' ? 'notice' : 'debug' ]);

    /**
     * Define default transformer
     */
    this.defaultTransformer = winston.format(function (info) {
      // Replace some %s to "%s" for display formating
      info.message = info.message.replace(/%s/g, '"%s"');

      // Try to get stack trace to buld format
      const stack  = stackTrace.get();
      const caller = _.size(stack) >= 22 ? stack[22] : null;

      // Has specified method ?
      if (_.isFunction(caller.getMethodName) &amp;&amp; _.isFunction(caller.getFileName)) {
        // Build default from
        info.from = caller.getMethodName() || caller.getFileName();

        // Remove working directory path to avoid long path in log
        info.from = info.from.replace(process.cwd(), '');

        // Typeame is a specific class ?
        if (!path.extname(info.from) &amp;&amp; !_.includes(caller.getTypeName(), [ 'Object' ])) {
          // Append full path on log
          info.from = [ caller.getTypeName(), info.from ].join('.');
        }

        // Add line number to from
        info.from = [ info.from, caller.getLineNumber() ].join(':');
      }

      // Set level to uppercase and padded properly
      info.level = _.padEnd(info.level.toUpperCase(), 7, ' ');

      // Default statement
      return info;
    });

    /**
     * Default timestamp transformer
     */
    this.defaultTimestampFormat = winston.format(info =>{
      // Set default timestamp format
      info.timestamp = moment(info.timestamp).format('YYYY/MM/DD HH:mm:ss');

      // Default statement
      return info;
    });

    /**
     * Define here default print transformer to display data like we need
     */
    this.defaultPrintTranformer = winston.format.printf(info =>{
      // In case a label is defined
      if (!_.isUndefined(info.label)) {
        // Default statement
        return `[${info.timestamp}] -> ${info.level} - [${info.label}] : ${info.message}`;
      }

      // Default statement
      return `[${info.timestamp}] | ${info.level} -> [${info.from}] : ${info.message}`;
    });

    /**
     * Define here default print transformer for web access to display data like we need
     */
    this.defaultWebPrintTranformer = winston.format.printf(info =>info.message.replace(os.EOL, '')
    );

    /**
     * Default winston instance logger
     *
     * @public
     * @memberof Logger
     * @member {Instance} winston
     */
    this.winston = winston.createLogger({
      transports : [
        new winston.transports.Console({
          handleExceptions : true,
          format           : winston.format.combine(
            this.defaultTransformer(),
            winston.format.timestamp(),
            this.defaultTimestampFormat(),
            winston.format.label(),
            winston.format.colorize(),
            winston.format.splat(),
            this.defaultPrintTranformer
          )
        })
      ],
      silent : false,
      levels : winston.config.syslog.levels,
      level  : this.logLevel.name
    });

    // Default web logger
    this.webLogger = winston.createLogger();
  }

  /**
   * Wrapper function to enable log on console
   *
   * @param {Boolean} status true if we need to enable false otherwise
   * @return {Boolean} true in case of success false otherwise
   */
  enableConsole (status) {
    // Has a valid status
    status = _.isBoolean(status) ? status : true;

    // Parse all item
    _.each(this.winston.transports, transport =>{
      // Only in case of Console
      if (transport instanceof winston.transports.Console) {
        // Change transport silent status
        transport.silent = !status;
      }
    });

    // Default statement
    return false;
  }

  /**
   * Wrapper function to disable log on console
   *
   * @return {Boolean} true in case of success false otherwise
   */
  disableConsole () {
    // Log message
    this.info('[ Logger.disableConsole ] - Disabling console transport');

    // Do main process
    return this.enableConsole(false);
  }

  /**
   * Enable catching error on a daily rotate files
   * @param {Object} options options to use for new transporter
   *
   * @return {Boolean|Mixed} false in case of error otherwise winston.add return value
   */
  errorToDailyRotateFiles (options) {
    // Try to normalize options
    options = options || {};

    // Add default options
    options.extname = 'error';
    options.level = 'warning';
    options.canChangeLevel = false;

    // Default statement
    return this.addDailyRotateTransport(options);
  }

  /**
   * Enable morgan web logger and stream content to a rotate access log file
   * @param {Object} options options to use on daily logger
   * @return {Boolean|Mixed} morgan instance in case of success or false in case of error
   */
  accessRequestToDailyRotateFiles (options) {
    // Try to normalize options
    options = options || {};

    // Add default options
    options.extname = 'access';
    options.level = 'info';
    options.canChangeLevel = false;
    options.xheaders = options.xheaders || [];

    // Create a daily rotate file first
    if (this.addDailyRotateTransport(options, true)) {
      // Create a default stream to use with morgan
      this.webLogger.stream = {
        write : message =>{
          // Call web logger
          this.webLogger.info(message);
        }
      }

      // Default format to use
      const format = !options.xheaders ? 'combined' : [ morgan['combined'], '- :xheaders' ].join(' ');

      // In some case we need to enable extra token on log

      if (options.xheaders) {
        // Build a dynamic token
        morgan.token('xheaders', function (req) {
          // Build xheader values
          const xheaders = _.compact(_.map(req.headers, (header, key) =>{
            // Current key is on defined list ?
            if (_.includes(options.xheaders, key)) {
              // Default statement
              return [ '(', key, ') ', header ].join('');
            }

            // In other case return invalid statement
            return false;
          }));

          // Default statement is we dont have token

          return xheaders.join(' - ');
        });
      }

      // Default statement
      return morgan(format, {
        stream : this.webLogger.stream
      });
    }

    // Default statement
    return false;
  }

  /**
   * Adding transport on logger module
   *
   * @param {Object} options override options value on daily rotate
   * @param {Object} isWeb true if is for a web request logger (morgan) false otherwie
   * @return {Boolean|Mixed} false in case of error otherwise winston.add return value
   */
  addDailyRotateTransport (options, isWeb) {
    // Try to normalize options
    options = options || {};
    _.set(options, 'changeChangeLevel', options.canChangeLevel || true);
    _.set(options, 'extname', options.extname || 'combined');
    _.set(options, 'destination', path.resolve((options.destination || '.').replace(/\/+/g, '/').replace(/\/$/, '')));
    _.set(options, 'filename', [ _.compact([ '%DATE%', options.filename || '', options.extname ]).join('-'), 'log' ].join('.'));
    _.set(options, 'pattern', options.pattern || 'YYYYMMDD');
    _.set(options, 'zipped', options.zipped || true);
    _.set(options, 'size', options.size || '20m');
    _.set(options, 'delay', options.delay || '14d');
    _.set(options, 'level', options.level || 'debug');

    // Default try catch
    try {
      // Need to check if given path is writable
      if (fs.lstatSync(options.destination).isDirectory()) {
        // Add new daily rotate file
        const transport = new winston.transports.DailyRotateFile({
          dirname          : options.destination,
          filename         : options.filename,
          datePattern      : options.pattern,
          zippedArchive    : options.zipped,
          maxSize          : options.size,
          maxFiles         : options.delay,
          handleExceptions : !isWeb,
          colorize         : false,
          level            : options.level,
          canChangeLevel   : options.changeChangeLevel,
          format           : winston.format.combine(
            this.defaultTransformer(),
            winston.format.timestamp(),
            this.defaultTimestampFormat(),
            winston.format.label(),
            winston.format.splat(),
            isWeb ? this.defaultWebPrintTranformer : this.defaultPrintTranformer
          )
        });

        // In case of web Logger needed
        if (isWeb) {
          // Add to the web logrer
          return this.webLogger.add(transport);
        }

        // Add to the default logger
        return this.winston.add(transport);
      }

      // Do a warning message in this case
      this.warning('Cannot create daily rotate file log handler. Path %s is not a directory.', options.destination);
    } catch (e) {
      // To an error message in this case
      this.error('Cannot add a new daily rotate file : %s', e.message);
    }

    // Default statement
    return false;
  }

  /**
   * Change log level manually
   *
   * @param {String} name name of level
   */
  changeLogLevel (name) {
    // Search data
    const search   = _.find(this.levels, [ 'name', name ]);

    // Parse all transport and update value
    _.each(this.winston.transports, function (transport) {
      // Only in this case
      if (transport.name === 'console') {
        // And if can change level is set
        if (_.has(transport, 'options.canChangeLevel') &amp;&amp; _.get(transport, 'options.canChangeLevel')) {
          // Get previous value for log message
          transport.previousLevel = transport.level || transport.parent.level;

          // Update level of each transport
          transport.level = !_.isUndefined(search) ? search.name : null;

          // Do a notice message
          this.notice('Level change from %s to %s form transport %s', transport.previousLevel, transport.level, transport.name);
        }
      }
    }.bind(this));

    // In case of undefined we set each level to null to keep parent level do his job
    // but we notify on console after the process
    if (_.isUndefined(search)) {
      // Log a notice message
      this.notice('Invalid level value. The defaut value %s was used.', this.winston.level);
    }
  }

  /**
   * Default log function. This method call winston logger with correct level of logs.
   * Specific transport can be used in last param to use a specific transport.
   *
   * @param {Integer} level level to use on current log level
   * @param {String} message default message to display
   * @param {Object} meta default meta to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  process (level, message, meta) {
    // Try to find correct level
    level = _.find(this.levels, [ 'name', level ]);

    // Level allow callback usage ?
    if (level.useCallback) {
      // Is a callback if defined call this with message and level
      if (this.callback &amp;&amp; _.isFunction(this.callback)) {
        // Default callback action
        return callback(level, message, meta);
      }
    }

    // Default log process
    return this.winston.log(... _.flattenDeep([ level.fn, message, meta ]));
  }

  /**
   * Log message and metadata with the current emergency level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  emergency (message, ... meta) {
    // Call main log process with emergency level
    return this.process('emergency', message, meta);
  }

  /**
   * Log message and metadata with the current alert level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  alert (message, ... meta) {
    // Call main log process with alert level
    return this.process('alert', message, meta);
  }

  /**
   * Log message and metadata with the current critical level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  critical (message, ... meta) {
    // Call main log process with critical level
    return this.process('critical', message, meta);
  }

  /**
   * Log message and metadata with the current error level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  error (message, ... meta) {
    // Call main log process with error level
    return this.process('error', message, meta);
  }

  /**
   * Log message and metadata with the current warning level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  warning (message, ... meta) {
    // Call main log process with warning level
    return this.process('warning', message, meta);
  }

  /**
   * Log message and metadata with the current notice level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  notice (message, ... meta) {
    // Call main log process with notice level
    return this.process('notice', message, meta);
  }

  /**
   * Log message and metadata with the current info level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  info (message, ... meta) {
    // Call main log process with info level
    return this.process('info', message, meta);
  }

  /**
   * Log message and metadata with the current debug level
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  debug (message, ... meta) {
    // Call main log process with debug level
    return this.process('debug', message, meta);
  }

  /**
   * Log a banner message on console
   *
   * @param {String} message message to send on logger
   * @param {Object} meta metadata to send on logger
   * @return {DerivedLogger} instance of derived logger
   */
  banner (message, ... meta) {
    // Format banner message before send to notice method
    message = [ _.repeat(' ', 10), message.toUpperCase(), _.repeat(' ', 10) ].join('');

    // Default call
    return this.process('info', chalk.bgWhite.black(message), meta);
  }

  /**
   * Default method to create a logger instance
   *
   * @return {Logger} an instance of current logger
   */
  static create () {
    // New logger instance
    return new Logger();
  }
}

/**
 * Export current logger to use it on node
 */
module.exports = Logger;
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>Documentation for application <b>yocto-logger<b>.<br/>Generated at Wed Aug 22 2018 14:48:47 GMT+0400 (+04) with <a href='https://www.npmjs.com/package/yoctodoc'>yocto-doc</a><br/>Copyright Yocto © 2018</footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  
  
</body>
</html>
